*qrexec.txt*  A Qrexec companion for the policy breakers
*qrexec* *qrexec.vim* *vim-qrexec*  Last Change:  2023 May 25
>
       ______     ______     ______     __  __     ______     ______
      /\  __ \   /\  == \   /\  ___\   /\_\_\_\   /\  ___\   /\  ___\
      \ \ \/\_\  \ \  __<   \ \  __\   \/_/\_\/_  \ \  __\   \ \ \____
       \ \___\_\  \ \_\ \_\  \ \_____\   /\_\/\_\  \ \_____\  \ \_____\
        \/___/_/   \/_/ /_/   \/_____/   \/_/\/_/   \/_____/   \/_____/
<
                                                 For Vim version 8.2 or newer

                                By Ben Grande
                           <ben.grande.b@gmail.com>

                              Reference Manual~

CONTENTS                                                     *qrexec-contents*

  Introduction...........................................|qrexec-introduction|
  Options................................................|qrexec-options|
  Lint...................................................|qrexec-lint|
  Syntax.................................................|qrexec-syntax|
  Completion.............................................|qrexec-completion|
  Spell..................................................|qrexec-spell|
  License................................................|qrexec-license|

INTRODUCTION                                             *qrexec-introduction*

Whenever you edit Qrexec files, a set of scripts are defined to help you
write syntactically correct policies and configurations, lint the buffer and
do code completion.

Although the policy syntax is small, it takes one syntax error to break the
parser, denying every Qrexec call made after the occurrence until the mistake
is removed. With the vimfiles provided by this plugin, you can greatly
decrease the chances of breaking your inter-qube connections.

Available file types and directories where they are detected automatically:
- qrexecpolicy:        /etc/qubes/policy.d/*.policy
- qrexecpolicyservice: /etc/qubes/policy.d/include/*
- qrexecconfig:        /etc/qubes/rpc-config/*

The source code is available at https://codeberg.org/ben.grande.b/vim-qrexec

OPTIONS                                                       *qrexec-options*

g:qrexec_recommended_style                        *g:qrexec_recommended_style*
        Type: |Number|, Default: `1`

        Enables or disables recommended style conventions. If enabled, the
        following options will be set: >
          setlocal expandtab tabstop=2 softtabstop=2 shiftwidth=2 textwidth=78

<        To disable the recommended behavior, set the following variable in
        your |.vimrc|: >
          let g:qrexec_recommended_style = 0
<
LINT                                                             *qrexec-lint*

Several commands are provided that wrap the `qubes-policy-lint` executable.
Additionally, `qubes-policy-lint` can be invoked directly with |:make| or
dispatch.vim's ":Make" or by ale.vim's ":ALELint". ALE's main advantage over
the previous methods is that it saves the buffer to a temporary file to lint a
copy of the original, instead of saving the file in place to be linted,
avoiding an erroneous file being applied just because you want it to be
linted. All of the above methods utilize the |quickfix-window|.

Note that linting can only be done from Dom0, as it requires the parser
provided by a Dom0 package.

SYNTAX                                                         *qrexec-syntax*

The Qrexec parser is strict, so the syntax check must also be. The syntax
highlighting goal is to show errors, the valid highlighting is just a nice
side effect to help distinguish the fields and their data types.

Every rule has a minimum and a maximum number of fields. While the line
hasn't reached the least amount of fields, the last group is highlighted as
incomplete:
>
  # qrexecpolicy
  qubes.Example * @anyvm @default
                         ^------^

  # qrexecpolicyservice
  @anyvm @anyvm
         ^----^

  # qrexecconfig
  wait-for-session =
  ^---------------^
<
On the other side, if the maximum number of fields has been reached,
everything after it will be highlighted as an error:
>
  # qrexecpolicy and qrexecpolicyservice
  !include-dir directory/ example test
                          ^----------^
<
Duplicated parameters are also highlighted as an error:
>
  # qrexecpolicy
  qubes.Example * * * allow target=test autostart=no target=diff
                                                     ^---------^

  # qrexecpolicyservice
  * * deny notify=no notify=yes
                     ^--------^
<
The syntax check is extensive but not perfect, it might fail on some edge
cases where showing the error by highlighting would not be clear enough. To
better understand its limitations, search for "TODO" and "Limitations" in the
source code.

COMPLETION                                                 *qrexec-completion*

A completion function is provided to help you. It can complete fields where
the possible values are known by the syntax file or literal names by previous
insertions of the literal name in the same field as the current one you are
trying to complete. You can use CTRL-X CTRL-U or CTRL-X CTRL-O during insert
mode. Consult |compl-function| and |compl-omni| for more help.

Note that the completion will not verify the syntax, so if you inserted an
erroneous entry on the file and the line reached the minimum number of fields,
then the erroneous item will also appear in the completion list. Make sure to
first correct all syntax errors before trying to complete a word.

SPELL                                                           *qrexec-spell*

The option 'spell' is enabled and 'spelllang' has the value "en_us" appended.
A spell file is appended to 'spellfile', thus you can use your own language
dictionary for comments while getting the benefits of having more good words
added to the list used by the spell checker.

The spell file is only used for comments, as the syntax disables spell
checking in rules to not distract the reader's attention, because most of the
words present there such as service names, arguments, qube names, tags and
user names are not in a common word list.

LICENSE                                                       *qrexec-license*

Copyright (c) Ben Grande. Distributed under the same terms as Vim itself.
See |license|.

 vim:tw=78:et:ft=help:norl:
